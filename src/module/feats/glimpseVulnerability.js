import { hasFeat } from "../utils/helpers.js";
import { findDeleteEVEffects } from "./exploit-vulnerability/exploitVulnerability.js";
import { createGWOnActor } from "./exploit-vulnerability/helpers.js";
import { GLIMPSE_VULNERABILITY_EFFECT_UUID } from "../utils/index.js";

export function glimpseVulnerability() {
  if (
    canvas.tokens.controlled.length != 1 ||
    Array.from(game.user.targets).length != 1
  ) {
    return ui.notifications.warn(
      game.i18n.localize(
        "pf2e-thaum-vuln.notifications.warn.exploitVulnerability.targetCount"
      )
    );
  }

  const actor = canvas.tokens.controlled[0].actor;
  const target = Array.from(game.user.targets)[0];

  if (hasFeat(actor, "thaumaturge-dedication")) {
    findDeleteEVEffects(actor);
    createGWOnActor(actor, target, GLIMPSE_VULNERABILITY_EFFECT_UUID);
  } else {
    return ui.notifications.warn(
      game.i18n.localize(
        "pf2e-thaum-vuln.notifications.warn.glimpseVulnerability.noGlimpseVulnerability"
      )
    );
  }
}
