import { GLIMPSE_VULNERABILITY_EFFECT_UUID } from "../utils";
import { hasFeat } from "../utils/helpers";
import { createEffectOnActor } from "./exploit-vulnerability/helpers";
import { preDeleteEffect } from "./exploit-vulnerability/exploitVulnerability";
import { deleteEVEffect } from "../socket";

export function glimpseVulnerability() {
  if (
    canvas.tokens.controlled.length != 1 ||
    Array.from(game.user.targets).length != 1
  ) {
    return ui.notifications.warn(
      game.i18n.localize(
        "pf2e-thaum-vuln.notifications.warn.exploitVulnerability.targetCount"
      )
    );
  }

  const a = canvas.tokens.controlled[0].actor;
  const deleteEffectTargs = preDeleteEffect(canvas.tokens.placeables, a);
  if (deleteEffectTargs.length > 0) {
    deleteEVEffect(deleteEffectTargs.flat());
  }

  const t = Array.from(game.user.targets)[0];
  if (hasFeat(a, "thaumaturge-dedication")) {
    createEffectOnActor(a, t, GLIMPSE_VULNERABILITY_EFFECT_UUID);
  } else {
    return ui.notifications.warn(
      game.i18n.localize(
        "pf2e-thaum-vuln.notifications.warn.glimpseVulnerability.noGlimpseVulnerability"
      )
    );
  }
}
